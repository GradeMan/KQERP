using System;
using System.Linq;
using System.Collections.Generic;
using COM.Data;
using ERP.Data;
using ERP.Domain;
using COM.Service;
using COM.Domain;
namespace ERP.Service
{
	public interface IProductService
	{
		ERP_M001_Product GetById(Guid Id);
        List<ERP_M001_Product> GetList();
        List<ERP_M001_Product> GetListByItemType(string itemType);
		List<ERP_M001_Product> GetList(PagingModel pagingModel, DateTime? beginDate, DateTime? endDate);
        void Create(ERP_M001_Product ERP_M001_Product);
        void Update(ERP_M001_Product ERP_M001_Product);
        void Delete(Guid Id);
        void DeleteCustPack(Guid id); //标记为删除，不立即执行
        void DeleteFile(Guid id);//标记为删除，不立即执行
        void DeleteMaterial(Guid id);//标记为删除，不立即执行
        void DeleteProcessFlow(Guid id);//标记为删除，不立即执行
        void DeleteProdInfo(Guid id);//标记为删除，不立即执行
        //void CreateCustPack(Guid id);
        //void CreateFile(Guid id);
        //void CreateMaterial(Guid id);
        //void CreateProcessFlow(Guid id);
        //void CreateCustPack(Guid id);
        //void Create(ERP_M001_Product ERP_M001_Product, List<ERP_M001_Product_CustPack> custPackList,List<ERP_M001_Product_File> fileList,List<ERP_M001_Product_Material> materialList,List<ERP_M001_Product_ProcessFlow> processFlowList,List<ERP_M001_Product_ProdInfo> prodInfoList);
        void Save(ERP_M001_Product ERP_M001_Product, List<ERP_M001_Product_CustPack> custPackList, List<ERP_M001_Product_File> fileList, List<ERP_M001_Product_Material> materialList, List<ERP_M001_Product_ProcessFlow> processFlowList, List<ERP_M001_Product_ProdInfo> prodInfoList);
        List<ERP_M001_Product_CustPack> GetCustPackListByProdutCode(string itemCode);
        List<ERP_M001_Product_File> GetProductFileByProdutCode(string itemCode);
        List<ERP_M001_Product_Material> GetMaterialByProdutCode(string itemCode);
        List<ERP_M001_Product_ProcessFlow> GetProcessFlowByProdutCode(string itemCode);
        List<ERP_M001_Product_ProdInfo> GetProdInfoByProdutCode(string itemCode);
        List<InputItem> GetProductInputData();
	}
    public class ProductService : IProductService
	{
		private IERP_M001_ProductRepository ERP_M001_ProductRepository;
        private IERP_M001_Product_CustPackRepository custPackRepository;
        private IERP_M001_Product_FileRepository fileRepository;
        private IERP_M001_Product_MaterialRepository materialRepository;
        private IERP_M001_Product_ProcessFlowRepository processFlowRepository;
        private IERP_M001_Product_ProdInfoRepository prodInfoReopsitory;
        private IERP_C001_CodeRepository codeRepository;
		private IUnitOfWork runtimeService;
		private ICacheServiceBase appCacheService = Unity.Instance.GetService<ICacheServiceBase>();
        public ProductService(IDatabaseFactory dbfactory)
		{
			this.runtimeService = new UnitOfWork(dbfactory);
			this.ERP_M001_ProductRepository = new ERP_M001_ProductRepository(dbfactory);
            this.custPackRepository = new ERP_M001_Product_CustPackRepository(dbfactory);
            this.fileRepository = new ERP_M001_Product_FileRepository(dbfactory);
            this.materialRepository = new ERP_M001_Product_MaterialRepository(dbfactory);
            this.processFlowRepository = new ERP_M001_Product_ProcessFlowRepository(dbfactory);
            this.prodInfoReopsitory = new ERP_M001_Product_ProdInfoRepository(dbfactory);
            this.codeRepository = new ERP_C001_CodeRepository(dbfactory);
		}

		public List<ERP_M001_Product> GetList()
        {
            var q = this.ERP_M001_ProductRepository.GetMany(i => true);
            return q.ToList();
        }

        public ERP_M001_Product GetById(Guid Id)
        {
            return this.ERP_M001_ProductRepository.GetByID(Id);
        }

        public void Create(ERP_M001_Product ERP_M001_Product)
        {
        	ERP_M001_Product.CreateDt = DateTime.Now;
            tb_Sys_User tempUser = appCacheService.GetItem("user") as tb_Sys_User;
            ERP_M001_Product.CreateUser = tempUser.UserName;
            ERP_M001_Product.CompCode = tempUser.CompCode;
            ERP_M001_Product.Validate();
			this.ERP_M001_ProductRepository.Add(ERP_M001_Product);
            //foreach (var custpack in productViewModel.CustPackList)
            //    this.custPackRepository.Add(custpack);
            this.runtimeService.Commit();
        }
        /// <summary>
        /// bia
        /// </summary>
        /// <param name="Id"></param>
        public void Delete(Guid Id)
        {
            var existstb_Sys_Menu = this.GetById(Id);
            this.ERP_M001_ProductRepository.Delete(existstb_Sys_Menu);
            this.runtimeService.Commit();
        }
        /// <summary>
        /// 标记CustPack为删除
        /// </summary>
        /// <param name="id"></param>
        public void DeleteCustPack(Guid id)
        {
            var existsCustPack = this.custPackRepository.GetByID(id);
            if (existsCustPack != null)
                this.custPackRepository.Delete(existsCustPack);
            //this.runtimeService.Commit();
        }
        //标记File为删除
        public void DeleteFile(Guid id)
        {
            var existsFile = this.fileRepository.GetByID(id);
            if (existsFile != null)
                this.fileRepository.Delete(existsFile);
        }
        public void DeleteMaterial(Guid id)
        {
            var existsTemp = this.materialRepository.GetByID(id);
            if (existsTemp != null)
                this.materialRepository.Delete(existsTemp);
        }

        public void DeleteProcessFlow(Guid id)
        {
            var existsTemp = this.processFlowRepository.GetByID(id);
            if (existsTemp != null)
                this.processFlowRepository.Delete(existsTemp);
        }

        public void DeleteProdInfo(Guid id)
        {
            var existsTemp = this.prodInfoReopsitory.GetByID(id);
            if (existsTemp != null)
                this.prodInfoReopsitory.Delete(existsTemp);
        }

        public void Update(ERP_M001_Product ERP_M001_Product)
        {
        	ERP_M001_Product.ModifyDt = DateTime.Now;
            tb_Sys_User tempUser = appCacheService.GetItem("user") as tb_Sys_User;
            ERP_M001_Product.ModifyUser = tempUser.UserName;
            ERP_M001_Product.Validate();
            var existstb_Sys_Menu = this.GetById(ERP_M001_Product.Id);
            this.ERP_M001_ProductRepository.SetValues(ERP_M001_Product, existstb_Sys_Menu);
            this.runtimeService.Commit();
        }

        public List<ERP_M001_Product> GetList(PagingModel pagingModel, DateTime? beginDate, DateTime? endDate)
        {
            var q = this.ERP_M001_ProductRepository.GetMany(i => true);
			if (beginDate.HasValue)
            {
                beginDate = beginDate.Value.Date;
           	    q = q.Where(p => p.CreateDt >= beginDate);
            }
            if (endDate.HasValue)
            {
                endDate = endDate.Value.Date.AddDays(1);
                q = q.Where(p => p.CreateDt < endDate);
            }
            
            q = q.OrderByDescending(i => i.CreateDt);
            q = q.Paging(pagingModel);
            return q.ToList();
        }

        /// <summary>
        /// 根据产品itemCode获取CustPack
        /// </summary>
        /// <param name="itemCode"></param>
        /// <returns></returns>
        public List<ERP_M001_Product_CustPack> GetCustPackListByProdutCode(string itemCode)
        {
            var q = this.custPackRepository.GetMany(i => i.ItemCode == itemCode);
            return q.ToList();
        }
        /// <summary>
        /// 根据产品itemCode获取File
        /// </summary>
        /// <param name="itemCode"></param>
        /// <returns></returns>
        public List<ERP_M001_Product_File> GetProductFileByProdutCode(string itemCode)
        {
            var q = this.fileRepository.GetMany(i => i.ItemCode == itemCode);
            return q.ToList();
        }
        public List<ERP_M001_Product_Material> GetMaterialByProdutCode(string itemCode)
        {
            var q = this.materialRepository.GetMany(i => i.ItemCode == itemCode);
            return q.ToList();
        }

        public List<ERP_M001_Product_ProcessFlow> GetProcessFlowByProdutCode(string itemCode)
        {
            var q = this.processFlowRepository.GetMany(i => i.ItemCode == itemCode);
            return q.ToList();
        }

        public List<ERP_M001_Product_ProdInfo> GetProdInfoByProdutCode(string itemCode)
        {
            var q = this.prodInfoReopsitory.GetMany(i => i.ItemCode == itemCode);
            return q.ToList();
        }

        public void Save(ERP_M001_Product ERP_M001_Product, List<ERP_M001_Product_CustPack> custPackList, List<ERP_M001_Product_File> fileList, List<ERP_M001_Product_Material> materialList, List<ERP_M001_Product_ProcessFlow> processFlowList, List<ERP_M001_Product_ProdInfo> prodInfoList)
        {
            tb_Sys_User tempUser = appCacheService.GetItem("user") as tb_Sys_User;
            var existsProduct = this.GetById(ERP_M001_Product.Id);
            if (existsProduct == null)
            {
                ERP_M001_Product.CreateDt = DateTime.Now;
                ERP_M001_Product.CreateUser = tempUser.UserName;
                ERP_M001_Product.CompCode = tempUser.CompCode;
                ERP_M001_Product.Validate();
                this.ERP_M001_ProductRepository.Add(ERP_M001_Product);
            }
            else
            {
                ERP_M001_Product.ModifyDt = DateTime.Now;
                ERP_M001_Product.ModifyUser = tempUser.UserName;
                ERP_M001_Product.Validate();
                this.ERP_M001_ProductRepository.SetValues(ERP_M001_Product, existsProduct);
            }
            if (custPackList != null)
            {
                foreach (var custPack in custPackList)
                {
                    var existstCustpack = this.custPackRepository.GetByID(custPack.Id);
                    if (existstCustpack == null)
                    {
                        custPack.CompCode = tempUser.CompCode;
                        custPack.CreateDt = DateTime.Now;
                        custPack.CreateUser = tempUser.UserName;
                        custPack.Validate();
                        this.custPackRepository.Add(custPack);
                    }
                    else
                    {
                        custPack.ModifyDt = DateTime.Now;
                        custPack.ModifyUser = tempUser.UserName;
                        custPack.Validate();
                        this.custPackRepository.SetValues(custPack, existstCustpack);
                    }
                }
            }
            if (fileList != null)
            {
                foreach (var file in fileList)
                {
                    var existstfile = this.fileRepository.GetByID(file.Id);
                    if (existstfile == null)
                    {
                        file.CompCode = tempUser.CompCode;
                        file.CreateDt = DateTime.Now;
                        file.CreateUser = tempUser.UserName;
                        file.Validate();
                        this.fileRepository.Add(file);
                    }
                    else
                    {
                        file.ModifyDt = DateTime.Now;
                        file.ModifyUser = tempUser.UserName;
                        file.Validate();
                        this.fileRepository.SetValues(file, existstfile);
                    }
                }
            }
            if (materialList != null)
            {
                foreach (var material in materialList)
                {
                    var existstmaterial = this.materialRepository.GetByID(material.Id);
                    if (existstmaterial == null)
                    {
                        material.CompCode = tempUser.CompCode;
                        material.CreateDt = DateTime.Now;
                        material.CreateUser = tempUser.UserName;
                        material.Validate();
                        this.materialRepository.Add(material);
                    }
                    else
                    {
                        material.ModifyDt = DateTime.Now;
                        material.ModifyUser = tempUser.UserName;
                        material.Validate();
                        this.materialRepository.SetValues(material, existstmaterial);
                    }
                }
            }
            if (processFlowList != null)
            {
                foreach (var processFlow in processFlowList)
                {
                    var existsttemp = this.processFlowRepository.GetByID(processFlow.Id);
                    if (existsttemp == null)
                    {
                        processFlow.CompCode = tempUser.CompCode;
                        processFlow.CreateDt = DateTime.Now;
                        processFlow.CreateUser = tempUser.UserName;
                        processFlow.Validate();
                        this.processFlowRepository.Add(processFlow);
                    }
                    else
                    {
                        processFlow.ModifyDt = DateTime.Now;
                        processFlow.ModifyUser = tempUser.UserName;
                        processFlow.Validate();
                        this.processFlowRepository.SetValues(processFlow, existsttemp);
                    }
                }
            }
            if (prodInfoList != null)
            {
                foreach (var prodInfo in prodInfoList)
                {
                    var existsttemp = this.prodInfoReopsitory.GetByID(prodInfo.Id);
                    if (existsttemp == null)
                    {
                        prodInfo.CompCode = tempUser.CompCode;
                        prodInfo.CreateDt = DateTime.Now;
                        prodInfo.CreateUser = tempUser.UserName;
                        prodInfo.Validate();
                        this.prodInfoReopsitory.Add(prodInfo);
                    }
                    else
                    {
                        prodInfo.ModifyDt = DateTime.Now;
                        prodInfo.ModifyUser = tempUser.UserName;
                        prodInfo.Validate();
                        this.prodInfoReopsitory.SetValues(prodInfo, existsttemp);
                    }
                }
            }
            this.runtimeService.Commit();
        }


        public List<InputItem> GetProductInputData()
        {
            var q = this.ERP_M001_ProductRepository.GetMany(i => true).ToList();
            var q2 = q.Select(i => new InputItem { DisPlayName = i.ItemName, Value = i.ItemCode, InputCode1 = i.ItemCode, InputCode2 = Util.PinYin.GetCodstring(i.ItemName) });
            return q2.ToList();
        }


        public List<ERP_M001_Product> GetListByItemType(string itemType)
        {
            var q = this.ERP_M001_ProductRepository.GetMany(i => i.ItemType == itemType);
            return q.ToList();
        }
    }
}